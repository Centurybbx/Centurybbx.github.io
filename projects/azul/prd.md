# 花砖物语（Azul）AI对战版本 - 游戏设计文档

## 一、游戏概述

### 1.1 游戏背景
花砖物语（Azul）是一款以葡萄牙阿兹勒赫瓷砖画为灵感的抽象策略桌游。玩家扮演瓷砖艺术家，通过收集和铺设瓷砖来装饰皇宫墙壁，在保持策略性的同时展现美学追求。

### 1.2 核心玩法
玩家通过从工厂或中央区域拿取瓷砖，放置到自己的花纹排，完成后铺设到墙壁上获得分数，同时需要避免瓷砖掉落地板造成扣分。

### 1.3 游戏信息
- **游戏人数**：2人（玩家 vs AI）
- **游戏时间**：30-45分钟
- **适合年龄**：8岁以上
- **策略深度**：中等

## 二、详细游戏规则

### 2.1 游戏组件

#### 2.1.1 瓷砖（100块）
- 5种颜色：蓝色、黄色、红色、绿色、橙色
- 每种颜色20块

#### 2.1.2 玩家版图（2个）
每个版图包含：
- **花纹排**：5排，长度分别为1-5格（从上到下）
- **墙壁**：5x5网格，有颜色模式
- **地板排**：7格（从左到右：-1, -1, -2, -2, -2, -3, -3）
- **计分区**：记录总分

#### 2.1.3 工厂圆盘（5个）
每个圆盘可放置4块瓷砖

#### 2.1.4 其他组件
- 起始玩家标记：1个
- 瓷砖袋：1个

### 2.2 游戏设置

#### 2.2.1 初始设置
1. 玩家和AI各获得一个玩家版图
2. 双方计分标记放在0的位置
3. 将所有瓷砖放入袋子
4. 起始玩家标记放在桌面中央

#### 2.2.2 工厂初始化
- 从袋子随机抽取20块瓷砖（5个圆盘 x 4块）
- 每个圆盘放置4块瓷砖
- 瓷砖随机分布在圆盘上

### 2.3 游戏流程

每回合分为两个阶段：**拿取瓷砖阶段**和**铺设墙壁阶段**

#### 2.3.1 拿取瓷砖阶段

##### 可执行动作（二选一）：

**动作A：从工厂拿取瓷砖**
- 选择一个圆盘
- 拿取该圆盘上**所有同颜色**的瓷砖
- 将该圆盘上剩余的瓷砖移动到桌面中央

**动作B：从中央拿取瓷砖**
- 拿取桌面中央**所有同颜色**的瓷砖
- 如果是本回合**第一个**从中央拿取瓷砖的玩家，需要额外拿起始玩家标记，放在地板排最左边的空格

##### 放置规则：
- 拿到的瓷砖必须放到花纹排的某一行
- 放置方向：从右到左依次放入
- 同一行只能放置**同一种颜色**的瓷砖
- 如果某行已经有瓷砖，后续放入的必须与已有瓷砖同色

##### 无法放置的处理：
- 如果瓷砖无法放入任何花纹排（颜色冲突或行已满），则整批瓷砖放到地板排
- 地板排从左到右放置，超出部分丢弃

##### 回合结束条件：
- 所有圆盘和中央都没有瓷砖后，进入铺设阶段

#### 2.3.2 铺设墙壁阶段

##### 执行顺序：
1. 按花纹排**从上到下**的顺序处理
2. 对于每个填满的花纹排（5格都满）：
   - 从该行选择一个瓷砖放置到墙壁上对应颜色位置
   - 放置位置：从左到右，墙壁上该颜色对应列的最上方空格
   - 墙壁每列只能放置**同一种颜色**的瓷砖
3. 未填满的花纹排保持原样
4. 铺设完成后，该花纹排清空
5. 丢入盒内的瓷砖从游戏中移除

##### 计分规则（铺设时即时计分）：
- 单独放置的瓷砖：+1分
- 水平方向相连的瓷砖数量（含自身）：N个则+ N分
- 垂直方向相连的瓷砖数量（含自身）：N个则+ N分
- 水平和垂直分别计算，可以同时获得两个方向的分数

**示例**：放置蓝色瓷砖
- 水平方向有3个相连蓝色瓷砖 → +3分
- 垂直方向有2个相连蓝色瓷砖 → +2分
- 本次铺设总计 +5分

##### 地板排扣分：
| 地板位置 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
|----------|---|---|---|---|---|---|---|
| 扣分 | -1 | -1 | -2 | -2 | -2 | -3 | -3 |

- 铺设阶段结束后，地板排清空（瓷砖丢弃）

### 2.4 新回合开始

如果没有人达成游戏结束条件：
1. 从袋子补充每个圆盘4块瓷砖
2. 如果袋子空了，将所有未使用的瓷砖放回袋子并重新装满

### 2.5 游戏结束条件

**结束触发**：当有玩家完成墙壁上**任意水平排**的5个瓷砖时，游戏立即结束

### 2.6 最终计分

游戏结束时，除了即时分数外，还有额外奖励分数：

| 奖励项目 | 分数 |
|----------|------|
| 每条完成的水平排（5个瓷砖） | +2分 |
| 每条完成的垂直排（5个瓷砖） | +7分 |
| 每种收集完整的颜色（5个同色） | +10分 |

### 2.7 胜负判定

1. 总分最高的玩家获胜
2. 如果平手，完成更多水平排的玩家获胜
3. 如果仍然平手，则平局

### 2.8 特殊规则

#### 颜色冲突规则
- 如果墙壁上某列已经有某种颜色的瓷砖，对应的花纹排不能再放置该颜色的瓷砖
- 这是强制规则，无法违反

#### 花纹排放置限制
- 花纹排只能从右向左填充
- 中间不能有空位
- 同一行必须颜色统一

## 三、页面设计方案

### 3.1 整体布局设计

```
+------------------------------------------------------------------+
|  [游戏标题] 花砖物语 - AI对战版                                    |
+------------------------------------------------------------------+
|  [状态栏] 当前回合: 玩家 | 回合数: 3/∞                           |
+------------------------------------------------------------------+
|                               |                                   |
|  [玩家区域]                    |  [AI区域]                         |
|  +-------------------------+  |  +-------------------------+       |
|  | [玩家姓名]               |  |  [AI名称]                 |       |
|  | 分数: 12                |  |  分数: 15                 |       |
|  +-------------------------+  |  +-------------------------+       |
|  |                         |  |                                   |
|  |  [墙壁] 5x5网格         |  |  [墙壁] 5x5网格          |       |
|  |  +-------------------+  |  |  +-------------------+  |       |
|  |  | □ □ □ □ □         |  |  |  □ □ □ □ □         |  |       |
|  |  | □ □ □ □ □         |  |  |  □ □ □ □ □         |  |       |
|  |  | □ □ □ □ □         |  |  |  □ □ □ □ □         |  |       |
|  |  | □ □ □ □ □         |  |  |  □ □ □ □ □         |  |       |
|  |  | □ □ □ □ □         |  |  |  □ □ □ □ □         |  |       |
|  |  +-------------------+  |  |  +-------------------+  |       |
|  |                         |  |                                   |
|  |  [花纹排]               |  |  [花纹排]                         |
|  |  +-------------------+  |  |  +-------------------+  |       |
|  |  | ■ ■ □ □ □ | 蓝     |  |  | ■ ■ □ □ □ | 红     |  |       |
|  |  | ■ ■ ■ □ □ | 红     |  |  | ■ ■ ■ □ □ | 黄     |  |       |
|  |  | ■ ■ ■ ■ □ | 绿     |  |  | ■ ■ ■ ■ □ | 蓝     |  |       |
|  |  | ■ ■ ■ ■ ■ | 黄     |  |  | ■ ■ ■ ■ ■ | 绿     |  |       |
|  |  | ■ ■ ■ ■ ■ | 橙     |  |  | ■ ■ ■ ■ ■ | 橙     |  |       |
|  |  +-------------------+  |  |  +-------------------+  |       |
|  |                         |  |                                   |
|  |  [地板排]               |  |  [地板排]                         |
|  |  [-1] [-1] [-2] [-2]... |  |  [空] [空] [-1] [-1]...         | 
|  +-------------------------+  |  +-------------------------+       |
|                               |                                   |
+------------------------------------------------------------------+
|  [桌面区域 - 工厂圆盘]                                             |
|  +---+   +---+   +---+   +---+   +---+                            |
|  |■ ■|   |■ ■|   |■ ■|   |■ ■|   |■ ■|                            |
|  |■ ■|   |■ ■|   |■ ■|   |■ ■|   |■ ■|                            |
|  +---+   +---+   +---+   +---+   +---+                            |
|   圆盘1   圆盘2   圆盘3   圆盘4   圆盘5                            |
|                                                               |
|  [中央区域]                                                     |
|  +---+                                                         |
|  |■ ■ ■ ■|                                                     |
|  +---+                                                         |
+------------------------------------------------------------------+
|  [操作面板]                                                      |
|  [开始新游戏] [保存游戏] [游戏规则] [AI难度: 中等 ▼]              |
+------------------------------------------------------------------+
|  [消息/日志]                                                     |
|  > 你的回合，请选择要拿取的瓷砖...                                |
+------------------------------------------------------------------+
```

### 3.2 视觉设计规范

#### 3.2.1 颜色方案
- **背景色**：温暖的米白色（#F5F5DC）
- **游戏区域**：浅灰色背景（#E8E8E8）
- **边框颜色**：深棕色（#8B4513）
- **瓷砖颜色**：
  - 蓝色：#3498DB
  - 黄色：#F1C40F
  - 红色：#E74C3C
  - 绿色：#2ECC71
  - 橙色：#E67E22
- **高亮色**：金色（#FFD700）

#### 3.2.2 组件尺寸
- **单个瓷砖**：40px x 40px，圆角8px
- **工厂圆盘**：120px x 120px圆形
- **花纹排**：根据长度自适应
- **墙壁格子**：45px x 45px
- **地板排格子**：30px x 30px

#### 3.2.3 交互设计
- **悬停效果**：瓷砖放大1.1倍，添加阴影
- **点击效果**：瓷砖下沉2px
- **选中状态**：金色边框闪烁
- **禁用状态**：灰色滤镜，半透明50%

### 3.3 详细组件设计

#### 3.3.1 玩家版图设计
```
+------------------------------------------------------+
|  玩家: 人类                                           |
|  分数: 12                                            |
+------------------------------------------------------+
|                                                      |
|  [墙壁 - 5x5网格]                                    |
|  +----+----+----+----+----+                         |
|  |蓝  |红  |黄  |绿  |橙  |  <- 第5行（最后放置）   |
|  +----+----+----+----+----+                         |
|  |蓝  |红  |黄  |绿  |橙  |  <- 第4行               |
|  +----+----+----+----+----+                         |
|  |蓝  |红  |黄  |绿  |橙  |  <- 第3行               |
|  +----+----+----+----+----+                         |
|  |蓝  |红  |黄  |绿  |橙  |  <- 第2行               |
|  +----+----+----+----+----+                         |
|  |蓝  |红  |黄  |绿  |橙  |  <- 第1行（最先放置）   |
|  +----+----+----+----+----+                         |
|                                                      |
|  [花纹排 - 5排]                                      |
|  +----+----+----+----+----+  长度5                  |
|  |■   |■   |■   |■   |■   | 颜色: 蓝色             |
|  +----+----+----+----+----+                         |
|  +----+----+----+----+      长度4                   |
|  |■   |■   |■   |■   |      颜色: 红色             |
|  +----+----+----+----+                               |
|  +----+----+----+           长度3                   |
|  |■   |■   |■   |            颜色: 黄色            |
|  +----+----+----+                                    |
|  +----+----+              长度2                     |
|  |■   |■   |               颜色: 绿色              |
|  +----+----+                                          |
|  +---+                     长度1                     |
|  |■  |                      颜色: 橙色              |
|  +---+                                                |
|                                                        |
|  [地板排 - 7格]                                        |
|  +---+---+---+---+---+---+---+                        |
|  |-1 |-1 |-2 |-2 |-2 |-3 |-3 |                        |
|  +---+---+---+---+---+---+---+                        |
|  当前: [-1] [-1] [空] [空]...                         |
|                                                        |
+------------------------------------------------------+
```

#### 3.3.2 工厂圆盘设计
```
    工厂圆盘布局（俯视图）
    
        +---+
        |■  |
      +---+---+
      |■  |■  |
      +---+---+
        |■  |
        +---+

- 圆形底盘，直径120px
- 4个瓷砖呈菱形放置
- 可点击选中整个圆盘
- 选中时显示高亮边框
- 显示当前圆盘包含的瓷砖颜色提示
```

#### 3.3.3 中央区域设计
```
[中央区域]

+-----------------------+
|                       |
|     +-----------+     |
|     | ■ ■ ■ ■  |     |
|     | ■ ■ ■ ■  |     |
|     +-----------+     |
|                       |
|  起始玩家标记          |
|  (显示谁本回合先拿中央) |
+-----------------------+

- 显示当前中央所有瓷砖
- 瓷砖堆叠显示（最多显示4个）
- 点击可选择拿取颜色
- 显示起始玩家标记归属
```

### 3.4 交互流程设计

#### 3.4.1 玩家回合操作流程

```
1. 拿取瓷砖阶段
   ┌─────────────────────────────────────┐
   │ 步骤1: 选择来源                     │
   │   ├─ 点击工厂圆盘 → 选择圆盘        │
   │   └─ 点击中央区域 → 选择中央        │
   │                                      │
   │ 步骤2: 选择颜色（如果需要）          │
   │   - 自动显示可拿取的颜色            │
   │   - 玩家点击确认拿取                │
   │                                      │
   │ 步骤3: 放置到花纹排                  │
   │   - 自动放置到合法位置              │
   │   - 如果有冲突，显示提示            │
   │                                      │
   │ 步骤4: 处理多余瓷砖                 │
   │   - 自动放置到地板排                │
   │   - 显示扣分预览                    │
   └─────────────────────────────────────┘

2. 铺设阶段（自动）
   ┌─────────────────────────────────────┐
   │  - 按从上到下顺序处理花纹排         │
   │  - 自动放置到墙壁对应位置           │
   │  - 实时显示得分变化                │
   │  - 处理地板排扣分                  │
   │  - 播放动画效果                    │
   └─────────────────────────────────────┘
```

#### 3.4.2 动画效果设计

**瓷砖移动动画**：
- 持续时间：300ms
- 缓动效果：ease-in-out
- 路径：从来源位置 → 花纹排 → 墙壁

**铺设得分动画**：
- 数字跳动效果
- 绿色+分，红色-分
- 持续显示2秒后淡出

**胜利/失败动画**：
- 胜利：金色闪光 + "胜利"文字
- 失败：灰色滤镜 + "失败"文字

### 3.5 游戏状态管理

#### 3.5.1 游戏状态定义
```typescript
interface GameState {
  gamePhase: 'SETUP' | 'TILE_PICKING' | 'WALL_TILING' | 'GAME_OVER';
  currentPlayer: 'PLAYER' | 'AI';
  currentRound: number;
  turnPhase: 'FACTORY' | 'CENTER';
  firstPlayerFromCenter: 'PLAYER' | 'AI' | null;
}

interface PlayerState {
  id: string;
  name: string;
  score: number;
  wall: TileColor[][];  // 5x5墙壁
  patternLines: PatternLine[];  // 花纹排
  floorLine: TileColor[];  // 地板排
  completedRows: number;  // 完成水平排数
  completedColumns: number;  // 完成垂直排数
  completedColors: Set<TileColor>;  // 完成颜色数
}

interface PatternLine {
  length: number;  // 1-5
  color: TileColor | null;  // 当前行的颜色（如果有）
  tiles: TileColor[];  // 当前瓷砖
  isFull: boolean;  // 是否填满
}

interface Factory {
  id: number;
  tiles: TileColor[];  // 4个瓷砖位置
}

interface Center {
  tiles: TileColor[];
  firstPlayerToken: boolean;
}
```

#### 3.5.2 AI难度级别

**简单难度**：
- 随机选择可拿取的颜色
- 不考虑未来收益
- 反应时间：1秒

**中等难度**：
- 评估颜色匹配度
- 避免地板扣分
- 考虑墙壁得分潜力
- 反应时间：2秒

**困难难度**：
- 前瞻2-3步
- 预测对手策略
- 优化颜色收集
- 阻止对手得分
- 反应时间：3秒

## 四、AI算法设计

### 4.1 评估函数

```typescript
interface EvaluationResult {
  score: number;
  breakdown: {
    immediateScore: number;  // 即时得分
    futurePotential: number;  // 未来潜力
    riskPenalty: number;  // 风险惩罚
    blockingBonus: number;  // 阻挡奖励
  };
}

function evaluateMove(state: GameState, move: TileMove): EvaluationResult {
  // 1. 计算即时得分
  const immediateScore = calculateImmediateScore(move);
  
  // 2. 计算未来潜力
  const futurePotential = calculateFuturePotential(move);
  
  // 3. 风险惩罚（地板扣分可能性）
  const riskPenalty = calculateRiskPenalty(move);
  
  // 4. 阻挡奖励（阻止对手得分）
  const blockingBonus = calculateBlockingBonus(move, opponentState);
  
  return {
    score: immediateScore + futurePotential * 0.5 - riskPenalty + blockingBonus * 0.3,
    breakdown: { immediateScore, futurePotential, riskPenalty, blockingBonus }
  };
}
```

### 4.2 决策流程

```typescript
function makeAIDecision(gameState: GameState, aiState: PlayerState): TileMove {
  // 1. 生成所有可能的移动
  const possibleMoves = generatePossibleMoves(gameState, aiState);
  
  if (possibleMoves.length === 0) {
    // 没有合法移动，跳过
    return { type: 'SKIP' };
  }
  
  // 2. 评估每个移动
  const evaluatedMoves = possibleMoves.map(move => ({
    move,
    evaluation: evaluateMove(gameState, move)
  }));
  
  // 3. 选择最佳移动
  // 简单难度：随机选择
  // 中等难度：选择评估最高的
  // 困难难度：添加随机性避免可预测性
  const selectedMove = selectBestMove(evaluatedMoves, AI_DIFFICULTY);
  
  return selectedMove.move;
}
```

### 4.3 策略优化

#### 4.3.1 颜色平衡策略
- 保持5种颜色的均衡收集
- 优先收集容易配对的颜色

#### 4.3.2 位置规划策略
- 提前规划墙壁布局
- 避免颜色冲突
- 优化得分位置

#### 4.3.3 风险评估策略
- 评估地板扣分风险
- 避免过度拿取瓷砖
- 预留花纹排空间

## 五、技术实现建议

### 5.1 推荐技术栈
- **前端框架**：React + TypeScript
- **状态管理**：Redux Toolkit 或 Zustand
- **样式方案**：CSS Modules 或 styled-components
- **动画库**：Framer Motion
- **构建工具**：Vite

### 5.2 核心模块划分

```
src/
├── components/
│   ├── GameBoard/          # 游戏主界面
│   ├── PlayerArea/         # 玩家区域组件
│   ├── AIPlayerArea/       # AI区域组件
│   ├── FactoryDisplay/     # 工厂圆盘组件
│   ├── CenterArea/         # 中央区域组件
│   ├── PatternLine/        # 花纹排组件
│   ├── WallGrid/           # 墙壁网格组件
│   ├── FloorLine/          # 地板排组件
│   ├── ScoreBoard/         # 计分板组件
│   ├── GameControls/       # 游戏控制面板
│   └── Modal/              # 弹窗组件
├── hooks/
│   ├── useGameState.ts     # 游戏状态Hook
│   ├── usePlayerAction.ts  # 玩家操作Hook
│   ├── useAI.ts            # AI逻辑Hook
│   └── useAnimation.ts     # 动画控制Hook
├── store/
│   ├── gameStore.ts        # 游戏状态Store
│   └── aiStore.ts          # AI状态Store
├── utils/
│   ├── gameLogic.ts        # 游戏逻辑计算
│   ├── scoring.ts          # 计分算法
│   ├── aiStrategy.ts       # AI策略算法
│   └── validation.ts       # 规则验证
├── types/
│   └── game.ts             # TypeScript类型定义
└── assets/
    ├── tiles/              # 瓷砖图片资源
    └── sounds/             # 音效资源
```

### 5.3 开发优先级

**第一阶段（MVP）**：
1. 基础游戏框架搭建
2. 瓷砖拿取和放置逻辑
3. 墙壁铺设和计分系统
4. 简单AI实现

**第二阶段**：
1. 动画效果优化
2. AI难度分级
3. 游戏保存/加载
4. 游戏规则说明

**第三阶段**：
1. 高级动画效果
2. 统计数据分析
3. 多人游戏支持
4. 主题皮肤系统

## 六、扩展功能建议

### 6.1 百搭瓷砖扩展
- 实现百搭瓷砖的特殊规则
- 增加游戏变化性

### 6.2 多人游戏模式
- 支持2-4人对战
- 添加聊天功能
- 玩家匹配系统

### 6.3 排位系统
- 天梯排位
- 段位奖励
- 对战记录

### 6.4 成就系统
- 里程碑成就
- 每日挑战
- 特殊成就

## 七、测试用例

### 7.1 核心规则测试
- ✅ 瓷砖拿取和放置
- ✅ 花纹排颜色约束
- ✅ 墙壁铺设规则
- ✅ 计分计算
- ✅ 地板扣分
- ✅ 游戏结束判定

### 7.2 边界情况测试
- ⚠️ 花纹排填满但无法铺设（墙壁位置被占）
- ⚠️ 多个玩家同时触发游戏结束
- ⚠️ 瓷砖数量不足的情况
- ⚠️ 连续多回合无法完成任何铺设

### 7.3 AI测试
- ✅ AI能生成合法移动
- ✅ AI不会超时
- ✅ 不同难度有明确差异
- ✅ AI不会陷入死循环

## 八、总结

本设计文档详细规划了花砖物语（Azul）AI对战版本的完整实现方案，包括：

1. **完整的游戏规则**：涵盖标准规则的所有细节，包括特殊情况和边界处理
2. **详细的页面设计**：包括整体布局、组件设计、交互流程和视觉规范
3. **AI算法设计**：包含评估函数、决策流程和策略优化方案
4. **技术实现建议**：推荐技术栈、模块划分和开发优先级

这个设计方案确保了游戏的策略性、视觉美感和用户体验，能够让玩家在享受游戏乐趣的同时，感受到AI对手的挑战性。