(function(){"use strict";const I=["blue","yellow","red","black","teal"],b=[-1,-1,-2,-2,-2,-3,-3],w=b.length,W=[["blue","yellow","red","black","teal"],["teal","blue","yellow","red","black"],["black","teal","blue","yellow","red"],["red","black","teal","blue","yellow"],["yellow","red","black","teal","blue"]];function p(o){return structuredClone(o)}function _(o){return o==="human"?"ai":"human"}function D(o){return o.center.tiles.length>0?!1:o.factories.every(e=>e.length===0)}function F(o,e){const n=W[o].indexOf(e);if(n<0)throw new Error(`Invalid wall pattern row=${o} color=${e}`);return n}function M(o,e,t){return o[e].some(n=>n===t)}function g(o){const e=Math.min(o,w);let t=0;for(let n=0;n<e;n+=1)t+=b[n];return t}function C(o,e,t){const n=(i,f)=>o[i]?.[f]!==null&&o[i]?.[f]!==void 0;let r=0;for(let i=t-1;i>=0&&n(e,i);i-=1)r+=1;let l=0;for(let i=t+1;i<5&&n(e,i);i+=1)l+=1;let c=0;for(let i=e-1;i>=0&&n(i,t);i-=1)c+=1;let s=0;for(let i=e+1;i<5&&n(i,t);i+=1)s+=1;const a=r+1+l,u=c+1+s;return a>1&&u>1?a+u:Math.max(a,u)}function N(o){const e={blue:0,yellow:0,red:0,black:0,teal:0};for(let t=0;t<5;t+=1)for(let n=0;n<5;n+=1){const r=o[t][n];r&&(e[r]+=1)}return e}function h(o,e){return o[e].every(t=>t!==null)}function B(o){let e=0;for(let t=0;t<5;t+=1)h(o,t)&&(e+=1);return e}function j(o){let e=0;for(let t=0;t<5;t+=1){let n=!0;for(let r=0;r<5;r+=1)if(o[r][t]===null){n=!1;break}n&&(e+=1)}return e}function q(o){const e=N(o);let t=0;for(const n of I)e[n]===5&&(t+=1);return t}function G(o){const e=[];let t=!1;for(const n of o)n==="token"?t=!0:e.push(n);return{discard:e,hadToken:t}}function E(o){return[...new Set(o)]}function O(o,e,t){const n=o.pattern[e];return!(n.tiles.length>=n.capacity||n.color!==null&&n.color!==t||M(o.wall,e,t))}function d(o){if(o.phase!=="draft")return[];const e=o.players[o.active],t=[];for(let n=0;n<o.factories.length;n+=1){const r=o.factories[n];if(r.length!==0)for(const l of E(r)){for(let c=0;c<5;c=c+1)O(e,c,l)&&t.push({source:{kind:"factory",index:n},color:l,target:{kind:"pattern",row:c}});t.push({source:{kind:"factory",index:n},color:l,target:{kind:"floor"}})}}if(o.center.tiles.length>0)for(const n of E(o.center.tiles)){for(let r=0;r<5;r=r+1)O(e,r,n)&&t.push({source:{kind:"center"},color:n,target:{kind:"pattern",row:r}});t.push({source:{kind:"center"},color:n,target:{kind:"floor"}})}return t}function H(o,e){return d(o).some(n=>n.color===e.color&&n.source.kind===e.source.kind&&(n.source.kind!=="factory"||n.source.index===e.source.index)&&n.target.kind===e.target.kind&&(n.target.kind!=="pattern"||n.target.row===e.target.row))}function K(o,e){const t=[],n=[];for(const r of o)(r===e?t:n).push(r);return{taken:t,remaining:n}}function $(o,e){const t=[],n=[];for(const r of o)(r===e?t:n).push(r);return{taken:t,remaining:n}}function k(o,e,t){const n=[...o],r=[...e];for(const l of t)n.length<w?n.push(l):r.push(l);return{floor:n,discard:r}}function P(o,e){if(o.phase!=="draft")throw new Error("Cannot apply move outside draft phase");if(!H(o,e))throw new Error("Illegal move");const t=p(o),n=t.active,r=t.players[n];let l=[];if(e.source.kind==="factory"){const c=e.source.index,s=t.factories[c],a=K(s,e.color);l=a.taken,t.factories[c]=[],t.center.tiles.push(...a.remaining)}else{const c=$(t.center.tiles,e.color);l=c.taken,t.center.tiles=c.remaining,t.center.hasFirstPlayerToken&&(t.center.hasFirstPlayerToken=!1,t.firstPlayerTokenOwner=n,r.floor.tiles.length<w&&r.floor.tiles.unshift("token"))}if(e.target.kind==="pattern"){const c=e.target.row,s=r.pattern[c];if(s.tiles.length>=s.capacity){const a=k(r.floor.tiles,t.discard,l);r.floor.tiles=a.floor,t.discard=a.discard}else{if(s.color!==null&&s.color!==e.color)throw new Error("Pattern line has different color");if(M(r.wall,c,e.color))throw new Error("Color already present in wall row");const a=s.capacity-s.tiles.length,u=l.slice(0,a),i=l.slice(a);s.color===null&&u.length>0&&(s.color=e.color),s.tiles.push(...u);const f=k(r.floor.tiles,t.discard,i);r.floor.tiles=f.floor,t.discard=f.discard}}else{const c=k(r.floor.tiles,t.discard,l);r.floor.tiles=c.floor,t.discard=c.discard}return t.active=_(n),D(t)&&(t.phase="scoring"),t}function U(o){let e=o>>>0;return()=>{e+=1831565813;let t=e;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function m(o){const e=U(o);return{next:e,int(t){return Math.floor(e()*t)}}}function x(o,e){const t=o.active,n=o.players[t],r=g(n.floor.tiles.length),l=e.target.kind==="pattern"?n.pattern[e.target.row].tiles.length:0,c=e.source.kind==="center"&&o.center.hasFirstPlayerToken,a=P(o,e).players[t],u=g(a.floor.tiles.length),i=r-u,f=e.target.kind==="pattern"?a.pattern[e.target.row].tiles.length:0,T=Math.max(0,f-l),S=e.target.kind==="pattern"&&l<n.pattern[e.target.row].capacity&&f===n.pattern[e.target.row].capacity,A=S&&e.target.kind==="pattern"?C(n.wall,e.target.row,F(e.target.row,e.color)):0;return{total:-i*20+(S?60:0)+T*8+A*12+(c?5:0),floorPenaltyDelta:i,estimatedWallPlacementPoints:A}}function X(o,e){const t=d(o);if(t.length===0)throw new Error("No legal moves");const n=m(e);return t[n.int(t.length)]}function z(o,e){const t=d(o);if(t.length===0)throw new Error("No legal moves");const n=m(e),r=t.map(s=>{const a=x(o,s);return{move:s,score:a}});r.sort((s,a)=>a.score.total!==s.score.total?a.score.total-s.score.total:s.score.floorPenaltyDelta!==a.score.floorPenaltyDelta?s.score.floorPenaltyDelta-a.score.floorPenaltyDelta:a.score.estimatedWallPlacementPoints!==s.score.estimatedWallPlacementPoints?a.score.estimatedWallPlacementPoints-s.score.estimatedWallPlacementPoints:0);const l=r[0].score.total,c=r.filter(s=>s.score.total===l);return c[n.int(c.length)].move}function y(o,e,t){o.push({...t,stateAfter:p(e)})}function J(o,e,t){let n=t;for(;n-1>=0&&o[e][n-1]!==null;)n-=1;let r=t;for(;r+1<5&&o[e][r+1]!==null;)r+=1;let l=e;for(;l-1>=0&&o[l-1][t]!==null;)l-=1;let c=e;for(;c+1<5&&o[c+1][t]!==null;)c+=1;const s=[];for(let u=n;u<=r;u+=1)s.push({kind:"wall",row:e,col:u});const a=[];for(let u=l;u<=c;u+=1)a.push({kind:"wall",row:u,col:t});return s.length>1&&a.length>1?[...s,...a]:s.length>1?s:a.length>1?a:[{kind:"wall",row:e,col:t}]}function v(o,e,t){const n=o.players[e];for(let r=0;r<5;r+=1){const l=n.pattern[r];if(l.tiles.length!==l.capacity||!l.color)continue;const c=l.color,s=F(r,c);if(n.wall[r][s]!==null)throw new Error("Wall cell already occupied");const a=C(n.wall,r,s);n.wall[r][s]=c;const u=l.tiles.slice(1);o.discard.push(...u),l.tiles=[],l.color=null,y(t,o,{playerId:e,kind:"placement",row:r,col:s,color:c,pointsOrPenalty:0,scoreBefore:n.score,scoreAfter:n.score,highlightPath:[{kind:"wall",row:r,col:s}]});const i=n.score;n.score+=a,y(t,o,{playerId:e,kind:"adjacency",row:r,col:s,color:c,pointsOrPenalty:a,scoreBefore:i,scoreAfter:n.score,highlightPath:J(n.wall,r,s)})}}function R(o,e,t){const n=o.players[e],r=n.floor.tiles.length;if(r===0)return;const l=g(r),c=n.score;n.score=Math.max(0,n.score+l);const s=[];for(let u=0;u<r;u+=1)s.push({kind:"floor",slot:u});const a=G(n.floor.tiles);o.discard.push(...a.discard),n.floor.tiles=[],y(t,o,{playerId:e,kind:"floor_penalty",row:null,col:null,color:null,pointsOrPenalty:l,scoreBefore:c,scoreAfter:n.score,highlightPath:s})}function Q(o){const e=B(o.wall),t=j(o.wall),n=q(o.wall);return e*2+t*7+n*10}function V(o){if(o.phase!=="scoring")throw new Error("createRoundScoringPlan expects phase=scoring");const e=p(o),t=[],n=o.firstPlayerTokenOwner??"human",r=p(o);if(v(r,"human",t),v(r,"ai",t),R(r,"human",t),R(r,"ai",t),r.center.hasFirstPlayerToken=!0,r.firstPlayerTokenOwner=null,r.active=n,h(r.players.human.wall,0)||h(r.players.human.wall,1)||h(r.players.human.wall,2)||h(r.players.human.wall,3)||h(r.players.human.wall,4)||h(r.players.ai.wall,0)||h(r.players.ai.wall,1)||h(r.players.ai.wall,2)||h(r.players.ai.wall,3)||h(r.players.ai.wall,4)){for(const c of["human","ai"]){const s=r.players[c],a=Q(s);if(a<=0)continue;const u=s.score;s.score+=a,y(t,r,{playerId:c,kind:"end_bonus",row:null,col:null,color:null,pointsOrPenalty:a,scoreBefore:u,scoreAfter:s.score,highlightPath:[]})}r.phase="game_over"}else r.phase="draft",r.round+=1;return{initialState:e,steps:t,finalState:r}}function Y(o){return V(o).finalState}const Z={topK:8,maxRolloutsTotal:160,epsilon:.2};function L(o,e){const t=o.players[e];let n=0;for(const l of t.pattern)l.tiles.length<l.capacity&&(n+=l.tiles.length);const r=g(t.floor.tiles.length);return n+r}function tt(o,e,t,n){const r=d(o);if(r.length===0)throw new Error("No legal moves in rollout");if(t()<e)return r[n(r.length)];let l=[],c=-1/0;for(const s of r){const a=x(o,s);a.total>c?(c=a.total,l=[s]):a.total===c&&l.push(s)}return l[n(l.length)]}function et(o,e,t,n,r){let l=P(o,e);for(;l.phase==="draft";){const a=tt(l,t,n,r);l=P(l,a)}l.phase==="scoring"&&(l=Y(l));const c=l.players.ai.score-l.players.human.score,s=L(l,"ai")-L(l,"human");return c+.2*s}function nt(o,e,t={}){const n={...Z,...t},r=d(o);if(r.length===0)throw new Error("No legal moves");const l=r.map(i=>({move:i,score:x(o,i).total})).sort((i,f)=>f.score-i.score).slice(0,Math.min(n.topK,r.length)),c=m(e),s=l.map(()=>({sum:0,count:0}));for(let i=0;i<n.maxRolloutsTotal;i+=1){const f=i%l.length,T=et(o,l[f].move,n.epsilon,c.next,c.int);s[f].sum+=T,s[f].count+=1}let a=0,u=-1/0;for(let i=0;i<l.length;i+=1){const f=s[i].count===0?-1/0:s[i].sum/s[i].count;f>u?(u=f,a=i):f===u&&c.next()<.5&&(a=i)}return l[a].move}function ot(o,e,t){switch(e){case"easy":return X(o,t);case"medium":return z(o,t);case"hard":return nt(o,t);default:return e}}self.onmessage=o=>{const{requestId:e,state:t,difficulty:n,seed:r}=o.data,l=ot(t,n,r),c={requestId:e,move:l};self.postMessage(c)}})();
